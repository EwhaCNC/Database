# Lesson 4. SQL (Structured Query Language)

## 1. SQL
- 관계형 데이터베이스의 조작과 관리에 사용되는 데이터베이스 질의용언어
- 원하는 데이터가 무엇인지만 기술하면 됨(비절차적 언어)

<br>

### 1.1 SQL 분류
- **데이터 정의어(DDL)** : 테이블 생성, 변경, 제거 기능 제공
    - 테이블 생성 : CREATE TABLE
    - 테이블 변경 : ALTER TABLE
    - 테이블 삭제 : DROP TABLE
- **데이터 조작어(DML)** : 테이블에 새 데이터 삽입, 수정, 삭제, 검색 기능 제공
    - 데이터 검색 : SELECT
    - 데이터 삽입 : INSERT
    - 데이터 수정 : UPDATE
    - 데이터 삭제 : DELETE
- **데이터 제어어(DCL)** : 데이터 접근 및 사용 권한을 사용자별 부여, 취소 기능 제공

*공통)
- [] 생략 가능
- 대소문자 구분X

### 1.2 데이터 정의어(DDL)

> ### 1) CREATE TABLE : 테이블 생성
```sql
CREATE TABLE 테이블_이름 (
    속성_이름 데이터_타입 [NOT NULL] [DEFAULT 기본값] --널 값 허용 여부, 기본 값 필요 여부 결정
    [PRIMARY KEY (속성_리스트)]       --기본키 지정
    [UNIQUE (속성_리스트)]            --대체키 지정(기본키와 달리 null값 허용됨)
    [FOREIGN KEY (속성_리스트) REFERENCES 테이블_이름 (속성_리스트)] [ON DELETE 옵션] [ON UPDATE 옵션] --외래키 지정
                                     --어떤 테이블의 무슨 속성을 참조사흔지 REFERENCES 키워드 제시
                                     --참조 무결성 제약조건 유지 위해 참조되는 테이블에서 튜플 삭제 시 처리 방법 지정
                                     --* ON DELETE NO ACTION : 튜플 삭제x
                                     --* ON DELETE CASCADE : 함께 삭제
                                     --* ON DELETE SET NULL : 관련 튜플의 외래키 NULL 변경
                                     --* ON DELETE SET DEFAULT : 관련 튜플의 외래키 미리 지정한 기본 값으로 변경
    [CONSTRAINT 이름] [CHECK(조건)]   -- 특정 속성의 제약조건 지정
);
```
- 기본 제약사항, 기본키, 대체키, 외래키, 데이터 무결성을 위한 제약조건 정의
- 속성 데이터 타입: (언어마다 조금씩 다르게 사용)

|데이터 타입|<center>설명</center>|
|:---------:|----------------------|
|INT/INTEGER|정수|
|SMALLINT|INT보다 작은 정수
|CHAR(n)/CHARACTER(n)|길이가 n인 고정 길이의 문자열|
|VARCHAR(n)/CHARACTER VARYING(n)|최대 길이가 n인 가변 길이의 문자열 <br> -> 공간을 아낄 수 있음|
|NUMERIC(p,s)/DECIMAL(p,s)|고정 소수점 실수<br>- p: 소수점을 제외한 전체 숫자의 길이<br> - s: 소수점 이하 숫자의 길이|
|FLOAT(n)|길이가 n인 부동 소수점 실수|
|REAL|부동 소수점 실수|
|DATE|연,월,일로 표현되는 날짜|
|TIME|시,분,초로 표현되는 시간|
|DATETIME|날짜와 시간|

<br>

> ### 2) ALTER TABLE :테이블 변경

- 새로운 속성 추가
```sql
ALTER TABLE 테이블_이름
    ADD 속성_이름 데이터_타입 [NOT NULL] [DEFAULT 기본값];
```

- 새로운 속성 삭제: <br>
만약 삭제할 속성과 관련된 제약조건이 존재하면 속성 삭제X, 관련된 제약 조건 먼저 삭제해야 함
```sql
ALTER TABLE 테이블_이름
    DROP COLUMN 속성_이름;
```

> ### 3) DROP TABLE : 테이블 삭제

```sql
DROP TABLE 테이블_이름;
```
만약 삭제할 테이블을 참조하는 테이블이 있으면, 테이블 삭제x, 관련된 외래키 제악조건 먼저 삭제해야 함

<br>

### 1.3 데이터 조작어(DML)

> ### 1) SELECT : 데이터 검색

```sql
SELECT [ALL | DISTINCT] 속성_리스트 [AS 키워드] --검색하려는 속성이름 나열
                                               --*ALL : 튜플 중복 허용(생략 가능)
                                               --*DISTINCT : 튜플 중복 허용X
                                               --"AS 키워드"로 결과 테이블에 속성 이름 변경 가능
                                               --         (공백이 있으면 따옴표 필요)(생략 가능)

FROM 테이블_리스트                              --검색하려는 속성의 테이블 이름 나열

[WHERE 조건]                                   --키워드와 함께 비교 연산자와 논리 연산자 이용한 검색 조건 제시
                                               -- 숫자, 문자, 날짜 비교 가능
                                               -- 문자, 날짜는 ''로 표현

[GROUP BY 속성_리스트 [HAVING 조건] ]           -- 그룹별 검색
                                               --특정 속성 값이 같은 튜플을 모아 그룹만들고, 그룹별 검색
                                               --HAVING키워드로 그룹에 대한 조건 작성
                                               --그룹을 나누는 기준이 되는 속성을 SELECT절에 작성하는 것이 좋음

[ORDER BY 속성_리스트 [ASC | DESC] ]            --ORDER BY 키워드 순으로 정렬
                                               -- 오름차순(기본) : ASC (NULL값 마지막)
                                               -- 내림차순 : DESC (NULL값 먼저)
;
```

- 산술식을 이용한 검색
    - SELECT 키워드와 함께 산술식 제시
    - 속성의 값이 실제 변경되는 것은 아니고 결과 테이블에서만 계산된 결과 값이 출력됨
- 연산자 이용 검색

|비교 연산자|설명|논리 연산자|설명|
|:----:|-----|:-----:|---------|
|=|같다|AND|모든 조건을 만족해야 검색|
|<>|다르다|OR|여러 조건 중 하나만 만족해도 검색|
|<|작다|NOT|조건을 만족하지 않는 것만 검색|
|>|크다|||
|<=|작거나 같다|||
|>=|크거나 같다|||

- LIKE 이용 검색

|기호|<center>설명</center>|<center>예시</center>|<center>설명</center>|
|:--:|-----|----|-----|
|%|0개 이상의 문자 <br>(문자의 내용,개수 상관X)|LIKE 'data%' <br> LIKE '%data' <br> LIKE '%data%'| data로 시작하는 문자열<br> data로 끝나는 문자열 <br> data가 포함된 문자열|
|_|1개의 문자<br>(문자의 내용 상관X)|LIKE 'data____' <br> LIKE'____data' |data로 시작하는 8자리 문자열 <br> data로 끝나는 8자리 문자열|

- NULL 이용한 검색
    - IS NULL : 속성의 값이 널 값인지를 비교
    - IS NOT NULL : 속성의 값이 널 값이 아닌지를 비교
    - NULL 값과 다른 값 비교하면 결과가 모두 False

- 집계함수 이용한 검색
    - 특정 속성 값을 통계적으로 계산한 결과를 검색하기 위해 집계 함수 사용
    - 집계함수 : COUNT, MAX, MIN, SUM, AVG 등
    - NULL 값 제외하고 계산됨
    - SELECT절, HAVING절에서만 사용 가능

- 조인 검색
    - 조인 검색 : 여러 개의 테이블을 연결하여 데이터를 검색하는 것
    - 조인 속성 : 조인 검색을 위해 테이블을 연결해주는 속성
        - 연결하려는 테이블 간에 조인 속성의 이름은 달라도 되지만 도메인은 같아야 함
        - 일반적으로 외래키를 조인 속성으로 이용함
    - FROM절에 검색에 필요한 모든 테이블 나열
    - WHERE절에 조인 속성의 값이 같아야 함을 의미하는 조인 조건 제시
    - 같은 이름의 속성이 서로 다른 테이블에 존재할 수 있어 속성 이름 앞에 테이블 이름 표시 (*ex) 주문.주문고객*)

- 서브 쿼리를 이용한 검색
    - 서브쿼리문 : SELECT문 안에 또 다른 SELECT문을 포함하는 질의
        - 괄호로 묶어서 작성, ORDER BY절 사용x
        - 단일행 서브쿼리문 : 하나의 행 결과로 반환
        - 다중행 서브쿼리문 : 하나 이상의 행 결과로 반환
    - 서브쿼리문 먼저 수행하고, 그 결과를 이용해 메인쿼리문 수행
    - 서브쿼리문과 메인쿼리문 연결하는 연산자 필요
        - 단일행 서브쿼리문은 비교 연산자(=,<>,>,>=,<,<=) 사용 가능
        - 다중행 서브쿼리문은 비교 연산자 사용X
    - 서브쿼리에서 사용 가능 연산자

|연산자|설명|
|:---:|----|
|IN|서브쿼리문의 결과 값 중 일치하는 것이 있으면 검색 조건이 True|
|NOT IN|서브쿼리문의 결과 값 중 일치하는 것이 없으면 검색 조건이 True|
|EXISTS|서브쿼리문의 결과 값이 하나라도 존재하면 검색 조건이 True|
|NOT EXISTS|서브쿼리문의 결과 값이 하나도 존재X 검색 조건이 True|
|ALL|서브쿼리문의 결과 값 모두와 비교한 결과가 True면 검색 조건 만족<br>(비교 연산자와 함께 사용)|
|ANY / SOME |서브쿼리문의 결과 값 중 하나라도 비교한 결과가 True면 검색 조건 만족 <br> (비교 연산자와 함께 사용)|

> ### 2) INSERT : 데이터 삽입

- 데이터 직접 삽입

```sql
INSERT
INTO 테이블_이름[(속성_리스트)]  --튜플을 삽입할 테이블 이름과 속성 이름 나열
                               --속성 리스트 생략하면 테이블이 정의된 속성 순서대로 삽입
VALUES (속성값_리스트)          --삽입할 속성값 나열
;
```

- 서브쿼리문 이용한 데이터 삽입

```sql
INSERT
INTO 테이블_이름[(속성_리스트)]  
SELECT 문;                      --SELECT문 검색 결과를 삽입
;
```

> ### 3) UPDATE : 데이터 수정

```sql
UPDATE 테이블_이름
SET 속성_이름1 = 값1, 속성_이름2 = 값2, ...  --속성 값을 어떻게 수정할 것인지 지정
[WHERE 조건]                                --조건을 만족하는 튜플에 대해서만 속성 값 수정
;
```

> ### 4) DELETE : 데이터 삭제

```sql
DELETE
FROM 테이블_이름
[WHERE 조건]     --조건을 만족하는 튜플만 삭제
                 -- WHERE절 생략하면 모든 튜플 삭제해 빈테이블이 됨
;
```

<br>

### 1.4 VIEW

- 다른 테이블을 기반으로 만들어진 가상 테이블
- 데이터를 실제로 저장X 논리적으로만 존재하는 테이블
- 다른 뷰를 기반으로 새로운 뷰를 만드는 것도 가능
- 뷰를 통해 기본 테이블의 내용을 쉽게 검색할 수 있으나, <br> 기본 테이블의 내용을 변화시키는 작업은 제한적임
    - 기본테이블 : 뷰를 만드는데 기반이 되는 물리적인 테이블

> ### 1) CREATE VIEW : 뷰 생성

```sql
CREATE VIEW 뷰_이름 [(속성_리스트)]  --생성할 뷰 이름과 속성 이름 나열
                                    -- 속성 리스트 생략하면 SELECT절에 나열된 속성의 이름 그대로 사용

AS SELECT 문                        --기본 테이블에 대한 SELECT문 작성
                                    --ORDER BY 사용불가

[WITH CHECK OPTION]                 --뷰에 삽입,수정 연산할 때 
                                    --SELECT문에서 제시한 뷰의 정의 조건을 위반하면 
                                    --수행되지 않도록 제약조건 지정
;
```

> ### 2) SELECT VIEW

- 뷰는 일반 테이블과 같은 방법으로 원하는 데이터를 검색할 수 있음
- 뷰에 대한 SELECT문이 내부적으로 기본 테이블에 대한 SELECT문으로 변환되어 수행

- 검색 연산은 모든 뷰에서 수행 가능

> ### 3) INSERT, UPDATE, DELETE VIEW

- 뷰에 대한 삽입, 수정, 삭제 연산은 실제로 기본 테이블에 수행되므로 결과적으로는 기본 테이블이 변경됨
- 뷰에 대한 삽입, 수정, 삭제 연산은 제한적으로 수행됨
- 변경 불가능한 VIEW 특징
    - 기본 테이블의 기본키를 구성하는 속성이 포함되어 있지 않은 뷰
    - 기본 테이블에 있던 내용이 아닌 집계 함수로 새로 계산된 내용을 포함하는 뷰
    - DISTINCT 키워드를 포함하여 정의한 뷰
    - GROUP BY절을 포함하여 정의한 뷰
    - 여러 개의 테이블을 조인하여 정의한 뷰 (변경 불가능한 경우가 많음)
- VIEW 장점
    - 질의문을 좀 더 쉽게 작성 가능
        - GROUP BY, 집계함수, 조인 등을 이용해 뷰를 미리 만들어 놓으면 <br> 복잡한 SQL문을 작성하지 않아도 SELECT절과 FROM 절만으로 원하는 데이터 검색이 가능
    - 데이터의 보안 유지에 도움.
        - 자신에게 제공된 뷰를 통해서만 데이터에 접근하도록 권한 설정 가능
    - 데이터를 좀 더 편리하게 관리 가능.
        - 제공된 뷰와 관련이 없는 다른 내용에 대해 사용자가 신경 쓸 필요가 없음

> ### 3) DROP VIEW
```SQL
DROP VIEW 뷰_이름
;
```
- 뷰를 삭제해도 기본 테이블은 영향받지X
- 삭제할 VIEW를 참조하는 제약 조건이 있다면, 뷰 삭제가 수행되지 않음. 관련된 제약 조건 먼저 삭제해야 함.
(*Ex) 삭제할 뷰를 이용해 만들어진 다른 뷰가 존재하는 경우*)